<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
        }
        
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .result-item {
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }
        
        .result-item:hover {
            background-color: #f8fafc;
        }
        
        .result-item.success {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .result-item.warning {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .result-item.error {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.active {
            max-height: 2000px;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .status-success { background: #10b981; color: white; }
        .status-warning { background: #f59e0b; color: white; }
        .status-error { background: #ef4444; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="auth-overlay" id="authOverlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">üîí –î–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</h2>
            <p class="text-gray-600 mb-6 text-center">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å—É</p>
            <input type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-6" 
                   id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors" 
                    onclick="authenticate()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="mainApp" class="hidden">
        <div class="container mx-auto max-w-4xl px-4 py-6">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <header class="text-center mb-6">
                <div class="flex justify-end mb-4">
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        –í—ã–π—Ç–∏
                    </button>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">
                    üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
                </h1>
                <p class="text-gray-600 text-sm">
                    –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –§–ó-152 —Å —É—á–µ—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π 2025 –≥–æ–¥–∞
                </p>
            </header>

            <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 mb-6">
                <div class="p-6">
                    
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                    <div id="successAlert" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-green-800 text-sm font-medium"></p>
                    </div>
                    <div id="errorAlert" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-800 text-sm font-medium"></p>
                    </div>

                    <!-- –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ -->
                    <div class="mb-4 flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-6">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" class="form-radio h-4 w-4 text-blue-600" name="inputMethod" value="url" checked>
                            <span class="ml-2 text-gray-700 font-medium">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" class="form-radio h-4 w-4 text-blue-600" name="inputMethod" value="text">
                            <span class="ml-2 text-gray-700 font-medium">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞</span>
                        </label>
                    </div>

                    <!-- –ü–æ–ª–µ URL -->
                    <div id="urlInputContainer" class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:</label>
                        <input type="url" id="policyUrl" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="https://example.com/privacy">
                    </div>

                    <!-- –ü–æ–ª–µ —Ç–µ–∫—Å—Ç–∞ -->
                    <div id="textInputContainer" class="mb-4 hidden">
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">–¢–µ–∫—Å—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:</label>
                        <textarea id="policyText" rows="6"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª–∏—Ç–∏–∫–∏..."></textarea>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="analyzeBtn" onclick="analyzePolicy()"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            üîç –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É
                        </button>
                        <button onclick="clearResults()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
            <div id="loading" class="hidden text-center py-6">
                <div class="inline-block h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full spinner"></div>
                <p class="text-gray-600 mt-2">–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –§–ó-152...</p>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div id="results" class="hidden space-y-4">
                
                <!-- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                    <div class="flex items-center justify-between flex-col sm:flex-row gap-4">
                        <div class="flex items-center gap-3">
                            <div id="scoreCircle" class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold">
                                <span id="scoreValue">0%</span>
                            </div>
                            <div>
                                <h3 id="scoreTitle" class="font-semibold text-gray-900">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞</h3>
                                <p id="scoreDesc" class="text-gray-600 text-sm">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</p>
                            </div>
                        </div>
                        <div id="riskIndicator" class="px-3 py-1 rounded-lg font-semibold text-sm">
                            –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫
                        </div>
                    </div>
                </div>

                <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200">
                    <button onclick="toggleSection('detailedResults')" 
                            class="w-full p-4 text-left flex items-center justify-between font-semibold text-gray-900 hover:bg-gray-50">
                        <span>üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                        <span id="detailedResultsIcon" class="text-gray-500">‚ñº</span>
                    </button>
                    <div id="detailedResultsContent" class="collapsible-content">
                        <div class="p-4 border-t border-gray-200">
                            <div id="checksContainer" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200">
                    <button onclick="toggleSection('recommendations')" 
                            class="w-full p-4 text-left flex items-center justify-between font-semibold text-gray-900 hover:bg-gray-50">
                        <span>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
                        <span id="recommendationsIcon" class="text-gray-500">‚ñº</span>
                    </button>
                    <div id="recommendationsContent" class="collapsible-content">
                        <div class="p-4 border-t border-gray-200">
                            <div id="recList" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200">
                    <button onclick="toggleSection('legalInfo')" 
                            class="w-full p-4 text-left flex items-center justify-between font-semibold text-gray-900 hover:bg-gray-50">
                        <span>‚öñÔ∏è –ü—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã</span>
                        <span id="legalInfoIcon" class="text-gray-500">‚ñº</span>
                    </button>
                    <div id="legalInfoContent" class="collapsible-content">
                        <div class="p-4 border-t border-gray-200">
                            <h4 class="font-semibold text-gray-900 mb-3">–í–æ–∑–º–æ–∂–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è 152-–§–ó (2025):</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                                    <h5 class="font-semibold text-red-800 mb-2">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è:</h5>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        <li>‚Ä¢ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: –¥–æ 18 –º–ª–Ω —Ä—É–±.</li>
                                        <li>‚Ä¢ –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: –¥–æ 20 –º–ª–Ω —Ä—É–±.</li>
                                        <li>‚Ä¢ –ú–∞—Å—Å–æ–≤–∞—è —É—Ç–µ—á–∫–∞: –¥–æ 15 –º–ª–Ω —Ä—É–±.</li>
                                    </ul>
                                </div>
                                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <h5 class="font-semibold text-yellow-800 mb-2">–û–±—ã—á–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è:</h5>
                                    <ul class="text-sm text-yellow-700 space-y-1">
                                        <li>‚Ä¢ –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: –¥–æ 500 —Ç—ã—Å. —Ä—É–±.</li>
                                        <li>‚Ä¢ –ù–µ—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä–∞: –¥–æ 300 —Ç—ã—Å. —Ä—É–±.</li>
                                        <li>‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è: –¥–æ 500 —Ç—ã—Å. —Ä—É–±.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</h3>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="downloadReport('txt')" 
                                class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            üìÑ –°–∫–∞—á–∞—Ç—å TXT
                        </button>
                        <button onclick="downloadReport('html')" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            üìÑ –°–∫–∞—á–∞—Ç—å –¥–ª—è Word (HTML)
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        –û—Ç—á–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Compliance checks for Russian Federal Law 152-FZ (2025)
        const COMPLIANCE_CHECKS = [
            {
                id: 'general_provisions',
                title: 'General Provisions',
                description: 'Description of personal data processing principles',
                keywords: ['general provisions', 'processing principles', 'policy purpose', '152-fz', 'federal law'],
                required: true,
                priority: 'medium',
                lawRef: 'Art. 18.1 152-FZ',
                penalty: 'up to 300,000 RUB',
                recommendation: 'Add a "General Provisions" section describing the principles of legality, fairness, and good faith in processing personal data as per Art. 18.1 152-FZ.'
            },
            {
                id: 'operator_details',
                title: 'Operator Details',
                description: 'Name, OGRN, INN, legal address of the operator',
                keywords: ['ogrn', 'inn', 'name', 'legal address', 'operator', 'llc', 'jsc', 'sole proprietor', 'registered'],
                required: true,
                priority: 'critical',
                lawRef: 'p.1 part 1 Art.18.1 152-FZ',
                penalty: 'up to 300,000 RUB',
                recommendation: 'CRITICAL: Specify the full name of the organization, OGRN, INN, and legal address of the personal data operator.'
            },
            {
                id: 'contact_info',
                title: 'Contact Information',
                description: 'Contact details for personal data inquiries',
                keywords: ['contact', 'inquiry', 'personal data', 'email', 'phone', 'responsible', 'communication'],
                required: true,
                priority: 'high',
                lawRef: 'p.8 part 1 Art.18.1 152-FZ',
                penalty: 'up to 300,000 RUB',
                recommendation: 'Provide contact details of the person responsible for personal data processing (email, phone).'
            },
            {
                id: 'legal_grounds',
                title: 'Legal Grounds for Processing',
                description: 'References to Article 6 of 152-FZ with specific points',
                keywords: ['article 6', 'point 1', 'point 5', 'point 6', 'consent', 'contract', 'legitimate interests', 'legal grounds', 'processing basis'],
                required: true,
                priority: 'critical',
                lawRef: 'Art.6 152-FZ',
                penalty: 'up to 15 million RUB',
                recommendation: 'CRITICAL: Specify the legal grounds for processing with references to point 1 (consent), point 5 (contract), point 6 (legitimate interests) of part 1, Article 6 of 152-FZ.'
            },
            {
                id: 'processing_purposes',
                title: 'Purposes of Data Processing',
                description: 'Specific purposes for each category of processed data',
                keywords: ['processing purpose', 'collection purposes', 'registration', 'contract fulfillment', 'customer service', 'service provision'],
                required: true,
                priority: 'critical',
                lawRef: 'p.3 part 1 Art.18.1 152-FZ',
                penalty: 'up to 15 million RUB',
                recommendation: 'CRITICAL: Specify the purposes of processing for each category of personal data.'
            },
            {
                id: 'data_categories',
                title: 'Categories of Processed Data',
                description: 'Full list of types of collected personal data',
                keywords: ['surname', 'name', 'patronymic', 'email', 'phone', 'address', 'data categories', 'passport', 'personal data'],
                required: true,
                priority: 'high',
                lawRef: 'p.4 part 1 Art.18.1 152-FZ',
                penalty: 'up to 10 million RUB',
                recommendation: 'List all categories of processed personal data.'
            },
            {
                id: 'subject_categories',
                title: 'Data Subject Categories',
                description: 'List of categories of individuals whose data is processed',
                keywords: ['subject', 'client', 'user', 'visitor', 'employee', 'customer', 'buyer'],
                required: true,
                priority: 'medium',
                lawRef: 'p.4 part 1 Art.18.1 152-FZ',
                penalty: 'up to 5 million RUB',
                recommendation: 'List all categories of personal data subjects: clients, users, employees, etc.'
            },
            {
                id: 'retention_periods',
                title: 'Data Retention Periods',
                description: 'Specific retention periods for each data category',
                keywords: ['retention period', 'processing period', 'year', 'month', 'destruction', 'deletion', 'store', 'period'],
                required: true,
                priority: 'critical',
                lawRef: 'p.6 part 1 Art.18.1 152-FZ',
                penalty: 'up to 15 million RUB',
                recommendation: 'CRITICAL: Set specific retention periods for each category of personal data.'
            },
            {
                id: 'subject_rights',
                title: 'Data Subject Rights',
                description: 'Full description of data subject rights and procedures',
                keywords: ['subject rights', 'data access', 'modification', 'deletion', 'withdrawal of consent', 'blocking', 'information access'],
                required: true,
                priority: 'critical',
                lawRef: 'Art.14 152-FZ',
                penalty: 'up to 10 million RUB',
                recommendation: 'CRITICAL: Describe all rights of personal data subjects and procedures for their implementation.'
            },
            {
                id: 'response_timeframe',
                title: 'Response Timeframe for Requests',
                description: 'Specific response times for data subject requests',
                keywords: ['30 days', '10 working days', 'response timeframe', 'response to request', 'consider', 'reply'],
                required: true,
                priority: 'high',
                lawRef: 'part 4 Art.14 152-FZ',
                penalty: 'up to 5 million RUB',
                recommendation: 'Specify the response timeframe for data subject requests - no more than 30 days.'
            },
            {
                id: 'security_measures',
                title: 'Data Security Measures',
                description: 'Organizational and technical security measures',
                keywords: ['protection', 'security', 'technical measures', 'organizational measures', 'encryption', 'security measures'],
                required: true,
                priority: 'critical',
                lawRef: 'Art.19 152-FZ',
                penalty: 'up to 15 million RUB',
                recommendation: 'CRITICAL: Describe organizational and technical measures for personal data protection.'
            },
            {
                id: 'localization_2025',
                title: 'DATA LOCALIZATION (from 01.07.2025)',
                description: 'Processing and storage of data only in Russia',
                keywords: ['territory of russia', 'russian federation', 'localization', 'servers in russia', 'storage in russia', 'processing in russia'],
                required: true,
                priority: 'critical',
                lawRef: 'part 5 Art.18 152-FZ (from 01.07.2025)',
                penalty: 'up to 18 million RUB',
                recommendation: 'üö® CRITICAL: From 01.07.2025, all personal data of Russian citizens must be processed only in Russia.'
            },
            {
                id: 'separate_consent_2025',
                title: 'SEPARATE CONSENT (from 01.09.2025)',
                description: 'Consent must be a separate document',
                keywords: ['separate consent', 'separate document', 'independent of contract', 'separately', 'separate arrangement'],
                required: true,
                priority: 'critical',
                lawRef: 'part 4 Art.9 152-FZ (from 01.09.2025)',
                penalty: 'up to 15 million RUB',
                recommendation: 'üö® CRITICAL: From 01.09.2025, consent must be a separate document.'
            },
            {
                id: 'incident_notification',
                title: 'Incident Notification',
                description: 'Procedure for notifying Roskomnadzor of data breaches',
                keywords: ['incident', '24 hours', 'data breach', 'roskomnadzor', 'notification', 'security violation', 'report'],
                required: true,
                priority: 'critical',
                lawRef: 'part 6 Art.21 152-FZ (from 30.05.2025)',
                penalty: 'up to 20 million RUB',
                recommendation: 'CRITICAL: Specify the obligation to notify Roskomnadzor of incidents within 24 hours.'
            },
            {
                id: 'registry_notification',
                title: 'Roskomnadzor Notification',
                description: 'Notification of the start of data processing',
                keywords: ['roskomnadzor notification', 'operator registry', 'notification submission', 'registration', 'notify', 'submit'],
                required: true,
                priority: 'critical',
                lawRef: 'Art.22 152-FZ',
                penalty: 'up to 300,000 RUB',
                recommendation: 'CRITICAL: Submit a notification to Roskomnadzor about the start of personal data processing.'
            }
        ];
        let analysisData = null;
        // Authentication system
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('privacy_audit_auth') === 'true';
            if (isAuthenticated) {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('mainApp').classList.add('hidden');
            }
        }
        function authenticate() {
            const password = document.getElementById('authPassword').value;
            if (password === '1234') {
                localStorage.setItem('privacy_audit_auth', 'true');
                checkAuth();
                document.getElementById('authPassword').value = '';
            } else {
                alert('Incorrect password');
                document.getElementById('authPassword').value = '';
            }
        }
        function logout() {
            localStorage.removeItem('privacy_audit_auth');
            checkAuth();
        }
        // Section toggling
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const icon = document.getElementById(sectionId + 'Icon');
            content.classList.toggle('active');
            icon.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
        }
        // Input method switching
        document.addEventListener('DOMContentLoaded', () => {
            const inputMethodRadios = document.querySelectorAll('input[name="inputMethod"]');
            const urlContainer = document.getElementById('urlInputContainer');
            const textContainer = document.getElementById('textInputContainer');
            inputMethodRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'url') {
                        urlContainer.classList.remove('hidden');
                        textContainer.classList.add('hidden');
                    } else {
                        urlContainer.classList.add('hidden');
                        textContainer.classList.remove('hidden');
                    }
                    clearResults();
                });
            });
            checkAuth();
            document.getElementById('authPassword').addEventListener('keypress', e => {
                if (e.key === 'Enter') authenticate();
            });
        });
        // Alert functions
        function showAlert(msg, type = 'error') {
            const alertEl = document.getElementById(type === 'error' ? 'errorAlert' : 'successAlert');
            alertEl.querySelector('p').textContent = msg;
            alertEl.classList.remove('hidden');
            setTimeout(() => alertEl.classList.add('hidden'), 5000);
        }
        function clearResults() {
            document.getElementById('policyUrl').value = '';
            document.getElementById('policyText').value = '';
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('successAlert').classList.add('hidden');
            document.getElementById('errorAlert').classList.add('hidden');
        }
        // Main analysis function (–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–æ –ø–æ–¥ –æ–¥–∏–Ω —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–∫—Å–∏)
        async function analyzePolicy() {
            document.getElementById('successAlert').classList.add('hidden');
            document.getElementById('errorAlert').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');

            const isUrl = document.querySelector('input[name="inputMethod"]:checked').value === 'url';
            let content = '';

            if (isUrl) {
                const url = document.getElementById('policyUrl').value.trim();
                if (!url) return showAlert('–£–∫–∞–∂–∏—Ç–µ URL –¥–æ–∫—É–º–µ–Ω—Ç–∞');
                if (!/^https?:\/\//.test(url)) return showAlert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL');
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('analyzeBtn').disabled = true;
                try {
                    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const resp = await fetch(proxy);
                    if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                    content = await resp.text();
                    // –û—á–∏—â–∞–µ–º –æ—Ç html —Ç–µ–≥–æ–≤
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(content, 'text/html');
                    const elementsToRemove = ['script', 'style', 'nav', 'header', 'footer', 'aside', '.menu', '.navigation', '.ads', '.sidebar'];
                    elementsToRemove.forEach(selector => {
                        doc.querySelectorAll(selector).forEach(el => el.remove());
                    });
                    content = doc.body ? (doc.body.textContent || doc.body.innerText || '') : '';
                    content = content.replace(/\s+/g, ' ').trim();
                    if (!content || content.length < 200) {
                        throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                    }
                } catch (error) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('analyzeBtn').disabled = false;
                    return showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç');
                }
            } else {
                content = document.getElementById('policyText').value.trim();
                if (content.length < 200) return showAlert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('analyzeBtn').disabled = true;
            }
            await new Promise(r => setTimeout(r, 1200));
            analysisData = performImprovedAnalysis(content);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = false;
            displayResults();
            showAlert('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }
        // Improved analysis function
        function performImprovedAnalysis(content) {
            const contentLower = content.toLowerCase()
                .replace(/[^\w–∞-—è\s]/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            const results = [];
            const recommendations = [];
            let criticalIssues = 0;
            let highIssues = 0;
            let passedCount = 0;
            COMPLIANCE_CHECKS.forEach(check => {
                let matches = 0;
                const totalKeywords = check.keywords.length;
                check.keywords.forEach(keyword => {
                    const keywordLower = keyword.toLowerCase().replace(/[^\w–∞-—è\s]/gi, ' ');
                    const patterns = [
                        new RegExp('\\b' + keywordLower.replace(/\s+/g, '\\s+') + '\\b', 'gi'),
                        new RegExp(keywordLower.replace(/\s+/g, '.*?'), 'gi')
                    ];
                    if (patterns.some(pattern => pattern.test(contentLower))) {
                        matches++;
                    }
                });
                let threshold = 0.3;
                if (check.priority === 'critical') threshold = 0.5;
                else if (check.priority === 'high') threshold = 0.4;
                else if (check.priority === 'medium') threshold = 0.3;
                else threshold = 0.2;
                const matchRatio = matches / totalKeywords;
                const passed = matchRatio >= threshold;
                if (passed) {
                    passedCount++;
                } else {
                    if (check.priority === 'critical') criticalIssues++;
                    else if (check.priority === 'high') highIssues++;
                    recommendations.push({
                        title: check.title,
                        description: check.description,
                        lawRef: check.lawRef,
                        penalty: check.penalty,
                        recommendation: check.recommendation,
                        priority: check.priority
                    });
                }
                results.push({
                    ...check,
                    passed,
                    matches,
                    totalKeywords,
                    matchRatio: Math.round(matchRatio * 100)
                });
            });
            const totalChecks = COMPLIANCE_CHECKS.length;
            const score = Math.round((passedCount / totalChecks) * 100);
            let riskLevel = 'low';
            if (criticalIssues >= 3 || score < 40) riskLevel = 'critical';
            else if (criticalIssues >= 1 || highIssues >= 3 || score < 70) riskLevel = 'high';
            else if (highIssues >= 1 || score < 85) riskLevel = 'medium';
            return {
                score,
                results,
                recommendations,
                criticalIssues,
                highIssues,
                passedCount,
                totalChecks,
                riskLevel
            };
        }
        // Display results
        function displayResults() {
            const {score, results, recommendations, riskLevel, passedCount, totalChecks} = analysisData;
            const scoreEl = document.getElementById('scoreValue');
            const circleEl = document.getElementById('scoreCircle');
            const titleEl = document.getElementById('scoreTitle');
            const descEl = document.getElementById('scoreDesc');
            const riskEl = document.getElementById('riskIndicator');
            scoreEl.textContent = score + '%';
            if (score >= 85) {
                circleEl.className = 'w-16 h-16 rounded-full flex items-center justify-center text-white font-bold bg-green-500';
                titleEl.textContent = 'Good Compliance';
                descEl.textContent = `Passed ${passedCount} of ${totalChecks} requirements`;
            } else if (score >= 70) {
                circleEl.className = 'w-16 h-16 rounded-full flex items-center justify-center text-white font-bold bg-yellow-500';
                titleEl.textContent = 'Improvements Needed';
                descEl.textContent = `Passed ${passedCount} of ${totalChecks} requirements`;
            } else {
                circleEl.className = 'w-16 h-16 rounded-full flex items-center justify-center text-white font-bold bg-red-500';
                titleEl.textContent = 'Serious Violations';
                descEl.textContent = `Passed ${passedCount} of ${totalChecks} requirements`;
            }
            const riskTexts = {
                'critical': 'CRITICAL RISK',
                'high': 'HIGH RISK',
                'medium': 'MEDIUM RISK',
                'low': 'LOW RISK'
            };
            const riskColors = {
                'critical': 'bg-red-500 text-white',
                'high': 'bg-orange-500 text-white',
                'medium': 'bg-yellow-500 text-white',
                'low': 'bg-green-500 text-white'
            };
            riskEl.textContent = riskTexts[riskLevel];
            riskEl.className = `px-3 py-1 rounded-lg font-semibold text-sm ${riskColors[riskLevel]}`;
            const checksContainer = document.getElementById('checksContainer');
            checksContainer.innerHTML = '';
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = `result-item p-3 rounded-lg ${result.passed ? 'success' : result.priority === 'critical' ? 'error' : 'warning'}`;
                const statusIcon = result.passed ? '‚úì' : '‚úó';
                const statusClass = result.passed ? 'status-success' : result.priority === 'critical' ? 'status-error' : 'status-warning';
                const priorityText = {
                    'critical': 'CRITICAL',
                    'high': 'IMPORTANT',
                    'medium': 'MEDIUM',
                    'low': 'LOW'
                }[result.priority];
                item.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="${statusClass} status-icon">${statusIcon}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900 text-sm">${result.title}</h4>
                                <span class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-700">${priorityText}</span>
                            </div>
                            <p class="text-gray-700 text-sm mb-1">${result.description}</p>
                            <p class="text-blue-600 text-xs">${result.lawRef}</p>
                            ${!result.passed ? `<p class="text-red-600 text-xs font-medium mt-1">Possible fine: ${result.penalty}</p>` : ''}
                            <p class="text-gray-500 text-xs mt-1">Matches found: ${result.matches}/${result.totalKeywords} (${result.matchRatio}%)</p>
                        </div>
                    </div>
                `;
                checksContainer.appendChild(item);
            });
            const recList = document.getElementById('recList');
            recList.innerHTML = '';
            if (recommendations.length > 0) {
                recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200';
                    const priorityColor = rec.priority === 'critical' ? 'text-red-600' : 
                                        rec.priority === 'high' ? 'text-orange-600' : 'text-yellow-600';
                    recDiv.innerHTML = `
                        <h5 class="font-semibold text-gray-900 mb-2 ${priorityColor} text-sm">${rec.title}</h5>
                        <p class="text-gray-700 text-sm mb-2">${rec.description}</p>
                        <p class="text-blue-600 text-sm mb-2"><strong>Legal basis:</strong> ${rec.lawRef}</p>
                        <p class="text-gray-900 text-sm mb-2"><strong>What to do:</strong> ${rec.recommendation}</p>
                        <p class="text-red-600 text-sm font-medium"><strong>Possible fine:</strong> ${rec.penalty}</p>
                    `;
                    recList.appendChild(recDiv);
                });
            } else {
                recList.innerHTML = '<div class="bg-green-50 p-3 rounded-lg border border-green-200"><p class="text-green-800 font-medium">No critical violations found</p><p class="text-green-700 text-sm">The policy complies with the main requirements of 152-FZ.</p></div>';
            }
            document.getElementById('results').classList.remove('hidden');
        }
        // Download report with correct encoding
        function downloadReport(format) {
            if (!analysisData) return showAlert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É');
            const reportText = generateDetailedReport();
            if (format === 'txt') {
                downloadAsText(reportText, 'otchet_o_problemakh_politiki.txt');
            } else if (format === 'html') {
                downloadAsHtml(reportText, 'otchet_o_problemakh_politiki.html');
            }
            showAlert('–û—Ç—á–µ—Ç —Å–∫–∞—á–∞–Ω', 'success');
        }
        function downloadAsText(content, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function downloadAsHtml(content, filename) {
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset=\"UTF-8\">
                    <title>–û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 2cm; }
                        h1, h2, h3 { color: #333; }
                        .critical { color: #dc2626; font-weight: bold; }
                        .important { color: #ea580c; font-weight: bold; }
                        .normal { color: #059669; }
                    </style>
                </head>
                <body>
                    ${content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                </body>
                </html>
            `;
            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'text/html;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function generateDetailedReport() {
            const reportDate = new Date().toLocaleString('en-GB');
            const {score, results, recommendations, criticalIssues, riskLevel} = analysisData;
            let report = `PRIVACY POLICY CHECK REPORT\nDate: ${reportDate}\nOverall score: ${score}%\nRisk level: ${riskLevel.toUpperCase()}\n\nIDENTIFIED ISSUES:\n`;
            let problemCount = 1;
            results.filter(r => !r.passed).forEach(result => {
                const priorityText = result.priority === 'critical' ? 'CRITICAL' : 
                                  result.priority === 'high' ? 'IMPORTANT' : 'MEDIUM';
                report += `\n${problemCount}. **${result.title}** (${priorityText})\n   Description: ${result.description}\n   Legal basis: ${result.lawRef}\n   Possible fine: ${result.penalty}\n   Matches found: ${result.matches}/${result.totalKeywords} (${result.matchRatio}%)\n   \n`;
                problemCount++;
            });
            if (recommendations.length > 0) {
                report += `\nRECOMMENDATIONS:\n`;
                recommendations.forEach((rec, index) => {
                    const priorityMarker = rec.priority === 'critical' ? 'üö® ' : 
                                         rec.priority === 'high' ? '‚ö†Ô∏è ' : 'üìã ';
                    report += `\n${index + 1}. ${priorityMarker}**${rec.title}**\n   ${rec.recommendation}\n   \n   Legal basis: ${rec.lawRef}\n   Possible consequences: ${rec.penalty}\n   \n`;
                });
            }
            report += `\nCRITICAL REQUIREMENTS FOR 2025:\n- From 01.07.2025: Mandatory localization of Russian citizens' data (fine up to 18 million RUB)\n- From 01.09.2025: Consent must be a separate document (fine up to 15 million RUB)\n- From 30.05.2025: Notification to Roskomnadzor of incidents within 24 hours\n\nIMPORTANT: This report is for informational purposes and does not replace legal advice.\nIt is recommended to consult personal data protection specialists for a detailed legal assessment and document preparation.\n\nReport generated by the automated 152-FZ compliance checking system.\n`;
            return report;
        }
    </script>
</body>
</html>
